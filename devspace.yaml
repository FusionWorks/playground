version: v1beta11

vars:
- name: IMAGE
  value: gateway

deployments:
- name: playground
  kubectl:
    manifests:
    - kubernetes/**

images:
  first-service:
    image: first-service
    dockerfile: services/first_service/Dockerfile
    context: services/first_service/
  gateway:
    image: gateway
    dockerfile: services/gateway/Dockerfile
    context: services/gateway/
  second-service:
    image: second-service
    dockerfile: services/second-service/Dockerfile
    context: services/second-service/

dev:
  replacePods:
    - imageSelector: ${IMAGE}
      replaceImage: ${IMAGE}
      patches:
        - op: replace
          path: spec.containers[0].command
          value: ["sleep"]
        - op: replace
          path: spec.containers[0].args
          value: ["9999999999"]
        - op: replace
          path: spec.containers[0].workingDir
          value: "/app"
  ports:
  - imageSelector: ${IMAGE}
    forward:
    - port: 8080
      remotePort: 3000
    - port: 9229
      remotePort: 9229
  open:
  - url: http://localhost:8080
  sync:
  - imageSelector: ${IMAGE}
    localSubPath: services/gateway/
    containerPath: /app
    excludePaths:
    - .git/
    - node_modules/
    - dist/
  terminal:
    imageSelector: ${IMAGE}
